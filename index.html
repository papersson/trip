<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a2e">
    <title>Chile Trip ‚Äî February 2026</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            overflow: hidden;
        }
        
        #map {
            height: 100vh;
            height: 100dvh;
            width: 100%;
        }
        
        /* Legend - desktop only */
        .legend {
            background: white;
            padding: 14px 16px;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            font-size: 12px;
            line-height: 1.5;
        }
        
        .legend h4 {
            margin-bottom: 10px;
            font-size: 13px;
            color: #1a1a2e;
            font-weight: 600;
            border-bottom: 2px solid #e63946;
            padding-bottom: 6px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .legend-item:last-child {
            margin-bottom: 0;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        .legend-line {
            width: 20px;
            height: 3px;
            margin-right: 8px;
            flex-shrink: 0;
            border-radius: 2px;
        }
        
        /* Info Panel */
        .info-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            max-width: 260px;
            max-height: calc(100vh - 100px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            padding: 14px 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        
        .panel-header h3 {
            color: #1a1a2e;
            font-size: 15px;
            font-weight: 600;
            margin: 0;
        }
        
        .panel-content {
            overflow-y: auto;
            flex: 1;
            -webkit-overflow-scrolling: touch;
        }
        
        .day-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.15s;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .day-item:hover {
            background: #f8f8f8;
        }
        
        .day-item:active {
            background: #f0f0f0;
        }
        
        .day-item:last-child {
            border-bottom: none;
        }
        
        .day-number {
            width: 32px;
            height: 32px;
            background: #e63946;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
            flex-shrink: 0;
        }
        
        .day-info {
            flex: 1;
            min-width: 0;
        }
        
        .day-location {
            font-weight: 600;
            color: #1a1a2e;
            font-size: 13px;
        }
        
        .day-dates {
            color: #e63946;
            font-size: 11px;
            font-weight: 500;
            margin-top: 2px;
        }
        
        .day-activity {
            color: #666;
            font-size: 11px;
            margin-top: 3px;
            line-height: 1.4;
        }
        
        .day-drive {
            color: #999;
            font-size: 10px;
            margin-top: 4px;
        }
        
        /* Popups */
        .leaflet-popup-content-wrapper {
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .leaflet-popup-content {
            margin: 12px 14px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 13px;
        }
        
        .popup-title {
            font-weight: 600;
            font-size: 14px;
            color: #1a1a2e;
            margin-bottom: 4px;
        }
        
        .popup-date {
            color: #e63946;
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 6px;
        }
        
        .popup-desc {
            color: #555;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .popup-meta {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
            font-size: 11px;
            color: #888;
        }

        .route-label {
            background: white;
            border: none;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            color: #666;
            white-space: nowrap;
        }
        
        /* Mobile toggle button */
        .panel-toggle {
            display: none;
            position: fixed;
            top: 12px;
            right: 12px;
            z-index: 1000;
            background: white;
            border: none;
            border-radius: 10px;
            padding: 10px 14px;
            font-size: 13px;
            font-weight: 600;
            color: #1a1a2e;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            cursor: pointer;
            font-family: inherit;
        }
        
        .panel-toggle:active {
            background: #f0f0f0;
        }
        
        /* Mobile panel */
        @media (max-width: 600px) {
            .legend {
                display: none;
            }
            
            .panel-toggle {
                display: block;
            }
            
            .info-panel {
                position: fixed;
                top: 0;
                right: 0;
                bottom: 0;
                max-width: 85vw;
                width: 300px;
                border-radius: 0;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                z-index: 1001;
                max-height: 100vh;
                max-height: 100dvh;
            }
            
            .info-panel.open {
                transform: translateX(0);
            }
            
            .panel-close {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 28px;
                height: 28px;
                background: #f0f0f0;
                border: none;
                border-radius: 50%;
                font-size: 18px;
                color: #666;
                cursor: pointer;
            }
            
            .panel-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.4);
                z-index: 1000;
            }
            
            .panel-overlay.open {
                display: block;
            }
            
            .day-item {
                padding: 14px 16px;
            }
            
            .day-number {
                width: 36px;
                height: 36px;
                font-size: 13px;
            }
            
            .leaflet-control-zoom {
                margin-bottom: 20px !important;
            }
        }
        
        @media (min-width: 601px) {
            .panel-close {
                display: none;
            }
        }

        /* Details toggle button */
        .details-toggle {
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 1000;
            background: white;
            border: none;
            border-radius: 10px;
            padding: 10px 14px;
            font-size: 13px;
            font-weight: 600;
            color: #1a1a2e;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            cursor: pointer;
            font-family: inherit;
        }

        .details-toggle:hover {
            background: #f8f8f8;
        }

        .details-toggle:active {
            background: #f0f0f0;
        }

        /* Details Modal */
        .details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .details-modal.open {
            display: flex;
        }

        .details-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 40px rgba(0,0,0,0.2);
        }

        .details-header {
            padding: 20px 24px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .details-header h2 {
            margin: 0;
            font-size: 18px;
            color: #1a1a2e;
        }

        .details-close {
            width: 32px;
            height: 32px;
            background: #f0f0f0;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .details-close:hover {
            background: #e0e0e0;
        }

        .details-body {
            padding: 24px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .details-intro {
            color: #666;
            font-size: 14px;
            margin: 0 0 24px 0;
        }

        .details-body h3 {
            font-size: 14px;
            color: #1a1a2e;
            margin: 24px 0 12px 0;
            padding-bottom: 6px;
            border-bottom: 2px solid #e63946;
        }

        .details-body h3:first-of-type {
            margin-top: 0;
        }

        .accom-card {
            background: #f8f8f8;
            border-radius: 10px;
            padding: 14px 16px;
            margin-bottom: 12px;
        }

        .accom-dates {
            font-size: 11px;
            font-weight: 600;
            color: #e63946;
            margin-bottom: 4px;
        }

        .accom-name {
            font-size: 15px;
            font-weight: 600;
            color: #1a1a2e;
        }

        .accom-location {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
        }

        .accom-details {
            font-size: 12px;
            color: #555;
            line-height: 1.6;
        }

        .plan-section {
            background: #f0f7ff;
            border-radius: 10px;
            padding: 14px 16px;
            font-size: 13px;
            line-height: 1.8;
            color: #333;
        }

        .notes-list {
            margin: 0;
            padding-left: 20px;
            font-size: 13px;
            color: #555;
            line-height: 1.8;
        }

        .itinerary-table, .distances-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .itinerary-table th {
            text-align: left;
            padding: 8px 12px;
            background: #f0f0f0;
            font-weight: 600;
            color: #1a1a2e;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .itinerary-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            color: #333;
        }

        .itinerary-table td:last-child {
            text-align: center;
            color: #888;
        }

        .total-nights {
            text-align: right;
            font-weight: 600;
            color: #e63946;
            font-size: 13px;
            margin: 8px 0 0 0;
        }

        .distances-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            color: #555;
        }

        .distances-table td:first-child {
            color: #333;
        }

        .distances-table td:last-child {
            text-align: right;
            font-weight: 500;
            color: #666;
            white-space: nowrap;
        }

        .highlight-group {
            margin-bottom: 16px;
        }

        .highlight-title {
            font-size: 12px;
            font-weight: 600;
            color: #1a1a2e;
            margin-bottom: 6px;
        }

        .highlight-item {
            font-size: 13px;
            color: #555;
            padding: 6px 0 6px 12px;
            border-left: 3px solid #2a9d8f;
            margin-bottom: 6px;
            line-height: 1.4;
        }

        .highlight-item strong {
            color: #1a1a2e;
        }

        @media (max-width: 600px) {
            .details-toggle {
                top: auto;
                bottom: 12px;
                left: 12px;
            }

            .details-content {
                max-height: 85vh;
            }

            .details-body {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <button class="panel-toggle" id="panelToggle">üá®üá± Itinerary</button>
    <button class="details-toggle" id="detailsToggle">üìã Details</button>
    <div class="panel-overlay" id="panelOverlay"></div>

    <!-- Details Modal -->
    <div class="details-modal" id="detailsModal">
        <div class="details-content">
            <div class="details-header">
                <h2>Chile Trip - February 2026</h2>
                <button class="details-close" onclick="closeDetails()">√ó</button>
            </div>
            <div class="details-body">
                <p class="details-intro">Road trip through northern Chile: Santiago to Atacama Desert and back along the coast.</p>

                <h3>Itinerary Overview</h3>
                <table class="itinerary-table">
                    <thead>
                        <tr><th>Dates</th><th>Location</th><th>Nights</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>Feb 8</td><td>Santiago</td><td>1</td></tr>
                        <tr><td>Feb 9‚Äì10</td><td>Valpara√≠so</td><td>2</td></tr>
                        <tr><td>Feb 11‚Äì12</td><td>San Pedro de Atacama</td><td>2</td></tr>
                        <tr><td>Feb 13</td><td>Antofagasta</td><td>1</td></tr>
                        <tr><td>Feb 14‚Äì15</td><td>Bah√≠a Inglesa</td><td>2</td></tr>
                        <tr><td>Feb 16‚Äì17</td><td>La Serena</td><td>2</td></tr>
                        <tr><td>Feb 18‚Äì19</td><td>Caj√≥n del Maipo</td><td>2</td></tr>
                        <tr><td>Feb 20</td><td>Fly home</td><td>‚Äî</td></tr>
                    </tbody>
                </table>
                <p class="total-nights">Total: 12 nights</p>

                <h3>Accommodation</h3>

                <div class="accom-card">
                    <div class="accom-dates">Feb 11‚Äì13</div>
                    <div class="accom-name">EcoLodge MAKTVB</div>
                    <div class="accom-location">San Pedro de Atacama</div>
                    <div class="accom-details">
                        Check-in: Wed Feb 11, 3:00 PM ¬∑ Check-out: Fri Feb 13, 12:00 PM<br>
                        ‚úì Parking ‚úì Breakfast ‚úì Laundry
                    </div>
                </div>

                <div class="accom-card">
                    <div class="accom-dates">Feb 13‚Äì14</div>
                    <div class="accom-name">AH Hotel</div>
                    <div class="accom-location">Antofagasta</div>
                    <div class="accom-details">
                        Check-in: Fri Feb 13, 3:30 PM ¬∑ Check-out: Sat Feb 14, 11:30 AM<br>
                        Transit stop (arrive late, leave early)<br>
                        ‚úì Parking ‚úì Laundry
                    </div>
                </div>

                <div class="accom-card">
                    <div class="accom-dates">Feb 14‚Äì16</div>
                    <div class="accom-name">AirBnB - Caba√±a Hermosa 1</div>
                    <div class="accom-location">Caldera (Bah√≠a Inglesa)</div>
                    <div class="accom-details">
                        2 bedrooms, 3 beds, 1 bath<br>
                        ‚úì Laundry ‚úì Pets allowed<br>
                        Free cancellation before Feb 13
                    </div>
                </div>

                <div class="accom-card">
                    <div class="accom-dates">Feb 16‚Äì18</div>
                    <div class="accom-name">Hotel Casa de Piedra</div>
                    <div class="accom-location">Coquimbo (La Serena)</div>
                    <div class="accom-details">
                        Camino Las Parcelas Lote 8, #5531<br>
                        Check-in: Mon Feb 16, 2:00 PM ¬∑ Check-out: Wed Feb 18, 12:00 PM<br>
                        ‚úì Breakfast ‚úì Close to beach ‚úì Parking ‚úì WiFi
                    </div>
                </div>

                <div class="accom-card">
                    <div class="accom-dates">Feb 18‚Äì20</div>
                    <div class="accom-name">Caba√±as Between Hills</div>
                    <div class="accom-location">San Alfonso (Caj√≥n del Maipo)</div>
                    <div class="accom-details">
                        30476 Camino Al Volc√°n<br>
                        Check-in: Wed Feb 18, 2:30 PM ¬∑ Check-out: Fri Feb 20, 12:30 PM<br>
                        2-bedroom apartment (1 full + 4 bunks) ¬∑ Kitchen ¬∑ Pool<br>
                        ‚úì Parking ‚úì Restaurant ‚úì Pet friendly<br>
                        Quiet hours: 11 PM ‚Äì 10 AM
                    </div>
                </div>

                <h3>Day Trips & Highlights</h3>

                <div class="highlight-group">
                    <div class="highlight-title">From Santiago (Feb 8)</div>
                    <div class="highlight-item">
                        <strong>Caj√≥n del Maipo</strong> ‚Äî Embalse El Yeso, Ba√±os Colina hot springs
                    </div>
                </div>

                <div class="highlight-group">
                    <div class="highlight-title">From San Pedro (Feb 11‚Äì12)</div>
                    <div class="highlight-item">
                        <strong>El Tatio Geysers</strong> ‚Äî 4am departure, 1.5h drive, 4,300m altitude
                    </div>
                    <div class="highlight-item">
                        <strong>Valle de la Luna</strong> ‚Äî Sunset visit, 20min from San Pedro
                    </div>
                </div>

                <div class="highlight-group">
                    <div class="highlight-title">En Route (Feb 13‚Äì14)</div>
                    <div class="highlight-item">
                        <strong>Mano del Desierto</strong> ‚Äî Giant hand sculpture, between San Pedro & Antofagasta
                    </div>
                    <div class="highlight-item">
                        <strong>Pan de Az√∫car NP</strong> ‚Äî Coastal desert, cacti, guanacos
                    </div>
                </div>

                <div class="highlight-group">
                    <div class="highlight-title">From La Serena (Feb 16‚Äì17)</div>
                    <div class="highlight-item">
                        <strong>Isla Damas</strong> ‚Äî Boat trip: penguins, dolphins, sea lions (1.5h drive)
                    </div>
                    <div class="highlight-item">
                        <strong>Valle del Elqui</strong> ‚Äî Pisco distilleries, Vicu√±a (1h drive)
                    </div>
                </div>

                <div class="highlight-group">
                    <div class="highlight-title">From Caj√≥n del Maipo (Feb 18‚Äì19)</div>
                    <div class="highlight-item">
                        <strong>Ba√±os Morales</strong> ‚Äî Natural thermal baths at 1,850m, open 24h
                    </div>
                </div>

                <h3>Final Days Plan</h3>
                <div class="plan-section">
                    <strong>Feb 18:</strong> Drive from La Serena (5h), day in Santiago, then to San Alfonso<br>
                    <strong>Feb 19:</strong> Full day in mountains ‚Äî Ba√±os Morales thermal baths<br>
                    <strong>Feb 20:</strong> Return early to Santiago, fly home
                </div>

                <h3>Driving Distances</h3>
                <table class="distances-table">
                    <tbody>
                        <tr><td>Santiago ‚Üí Valpara√≠so</td><td>1.5h</td></tr>
                        <tr><td>Valpara√≠so ‚Üí Santiago Airport</td><td>1.5h</td></tr>
                        <tr><td>Santiago ‚Üí Calama</td><td>‚úà 2h</td></tr>
                        <tr><td>Calama Airport ‚Üí San Pedro</td><td>1h</td></tr>
                        <tr><td>San Pedro ‚Üí Antofagasta</td><td>3.5h</td></tr>
                        <tr><td>Antofagasta ‚Üí Bah√≠a Inglesa</td><td>4.5h</td></tr>
                        <tr><td>Bah√≠a Inglesa ‚Üí La Serena</td><td>4.5h</td></tr>
                        <tr><td>La Serena ‚Üí Santiago</td><td>5h</td></tr>
                        <tr><td>Santiago ‚Üí San Alfonso</td><td>1.5h</td></tr>
                    </tbody>
                </table>

                <h3>Notes</h3>
                <ul class="notes-list">
                    <li>All accommodations have parking</li>
                    <li>Laundry available: San Pedro, Antofagasta, Bah√≠a Inglesa</li>
                    <li>Breakfast included: San Pedro, La Serena</li>
                </ul>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize map
        const map = L.map('map', {
            zoomControl: false,
            tap: true
        }).setView([-27.5, -70.5], 6);
        
        // Add zoom control
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        
        // Tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OSM</a> ¬© <a href="https://carto.com/">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);
        
        // Colors
        const colors = {
            sleep: '#e63946',
            highlight: '#2a9d8f',
            route: '#e63946',
            flight: '#7c3aed'
        };
        
        // Marker creators
        function createSleepMarker(label) {
            return L.divIcon({
                className: 'sleep-marker',
                html: `<div style="
                    background: ${colors.sleep};
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    border: 3px solid white;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: 700;
                    font-size: 12px;
                    color: white;
                    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                ">${label}</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15],
                popupAnchor: [0, -15]
            });
        }
        
        function createHighlightMarker() {
            return L.divIcon({
                className: 'highlight-marker',
                html: `<div style="
                    background: ${colors.highlight};
                    width: 16px;
                    height: 16px;
                    border-radius: 50%;
                    border: 2px solid white;
                    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
                "></div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8],
                popupAnchor: [0, -8]
            });
        }
        
        // Data - overnight stays with single-number labels
        const overnightStays = [
            {
                id: 1,
                label: '8',
                dates: 'Feb 8',
                name: 'Santiago',
                coords: [-33.4489, -70.6693],
                desc: 'Arrive. Day trip to Caj√≥n del Maipo.',
                nights: 1
            },
            {
                id: 2,
                label: '9',
                dates: 'Feb 9‚Äì10',
                name: 'Valpara√≠so',
                coords: [-33.0472, -71.6127],
                desc: 'Cerros, funiculars, street art, Neruda\'s house',
                drive: '1.5h from Santiago',
                nights: 2
            },
            {
                id: 3,
                label: '11',
                dates: 'Feb 11‚Äì12',
                name: 'San Pedro de Atacama',
                coords: [-22.9087, -68.1997],
                desc: 'El Tatio geysers, Valle de la Luna sunset',
                accom: 'EcoLodge MAKTVB. Breakfast, laundry.',
                drive: '‚úà Santiago ‚Üí Calama: 2h flight + 1h drive',
                nights: 2
            },
            {
                id: 4,
                label: '13',
                dates: 'Feb 13',
                name: 'Antofagasta',
                coords: [-23.6509, -70.3975],
                desc: 'Transit stop. Mano del Desierto en route.',
                accom: 'AH Hotel. Laundry.',
                drive: '3.5h from San Pedro',
                nights: 1
            },
            {
                id: 5,
                label: '14',
                dates: 'Feb 14‚Äì15',
                name: 'Bah√≠a Inglesa',
                coords: [-27.1167, -70.8667],
                desc: 'Beach break. Pan de Az√∫car NP en route.',
                accom: 'AirBnB Caba√±a Hermosa. Laundry.',
                drive: '4.5h from Antofagasta',
                nights: 2
            },
            {
                id: 6,
                label: '16',
                dates: 'Feb 16‚Äì17',
                name: 'La Serena',
                coords: [-29.9027, -71.2519],
                desc: 'Isla Damas penguins, Valle del Elqui pisco',
                accom: 'Hotel Casa de Piedra. Breakfast.',
                drive: '4.5h from Bah√≠a Inglesa',
                nights: 2
            },
            {
                id: 7,
                label: '18',
                dates: 'Feb 18‚Äì19',
                name: 'Caj√≥n del Maipo',
                coords: [-33.7083, -70.1833],
                desc: 'Mountains & Ba√±os Morales thermal baths. Fly home Feb 20.',
                accom: 'Caba√±as Between Hills',
                drive: '5h from La Serena',
                nights: 2
            }
        ];
        
        // Day trip highlights
        const highlights = [
            {
                date: 'Feb 8',
                name: 'Caj√≥n del Maipo',
                coords: [-33.78, -70.08],
                desc: 'Embalse El Yeso, Ba√±os Colina hot springs',
                from: 'Day trip from Santiago'
            },
            {
                date: 'Feb 12',
                name: 'El Tatio Geysers',
                coords: [-22.3333, -68.0167],
                desc: '4am departure. 4,300m altitude.',
                from: '1.5h from San Pedro'
            },
            {
                date: 'Feb 12',
                name: 'Valle de la Luna',
                coords: [-22.9167, -68.2833],
                desc: 'Sunset. Salt formations glowing gold.',
                from: '20min from San Pedro'
            },
            {
                date: 'Feb 13',
                name: 'Mano del Desierto',
                coords: [-24.1556, -70.1567],
                desc: 'Giant hand sculpture in the desert',
                from: 'Stop en route'
            },
            {
                date: 'Feb 14',
                name: 'Pan de Az√∫car NP',
                coords: [-26.1500, -70.6333],
                desc: 'Coastal desert. Cacti, guanacos.',
                from: 'Morning stop en route'
            },
            {
                date: 'Feb 17',
                name: 'Isla Damas',
                coords: [-29.2500, -71.4667],
                desc: 'Boat trip: penguins, dolphins, sea lions',
                from: '1.5h from La Serena'
            },
            {
                date: 'Feb 17',
                name: 'Valle del Elqui',
                coords: [-30.1, -70.5],
                desc: 'Pisco distilleries, Vicu√±a',
                from: '1h from La Serena'
            },
            {
                date: 'Feb 19',
                name: 'Ba√±os Morales',
                coords: [-33.8167, -70.0667],
                desc: 'Natural thermal baths at 1,850m. Open 24h.',
                from: '30min from San Alfonso'
            }
        ];
        
        // Helper to create a route segment with arrow
        function addRouteSegment(from, to, color, dashed) {
            const line = L.polyline([from, to], {
                color: color,
                weight: dashed ? 2 : 3,
                opacity: dashed ? 0.8 : 0.7,
                dashArray: dashed ? '6, 6' : null
            }).addTo(map);

            L.polylineDecorator(line, {
                patterns: [{
                    offset: '35%',
                    repeat: 0,
                    symbol: L.Symbol.arrowHead({
                        pixelSize: 12,
                        polygon: false,
                        pathOptions: { stroke: true, weight: 2, color: color, opacity: 0.9 }
                    })
                }]
            }).addTo(map);

            return line;
        }

        // Coordinates
        const coords = {
            santiago: [-33.4489, -70.6693],
            santiagoAirport: [-33.3930, -70.7858],
            valparaiso: [-33.0472, -71.6127],
            calamaAirport: [-22.4982, -68.9036],
            sanPedro: [-22.9087, -68.1997],
            antofagasta: [-23.6509, -70.3975],
            bahiaInglesa: [-27.1167, -70.8667],
            laSerena: [-29.9027, -71.2519],
            santiagoEnd: [-33.4569, -70.6483]
        };

        // Drive routes
        addRouteSegment(coords.santiago, coords.valparaiso, colors.route, false);
        addRouteSegment(coords.valparaiso, coords.santiagoAirport, colors.route, false);
        addRouteSegment(coords.calamaAirport, coords.sanPedro, colors.route, false);
        addRouteSegment(coords.sanPedro, coords.antofagasta, colors.route, false);
        addRouteSegment(coords.antofagasta, coords.bahiaInglesa, colors.route, false);
        addRouteSegment(coords.bahiaInglesa, coords.laSerena, colors.route, false);
        addRouteSegment(coords.laSerena, coords.santiagoEnd, colors.route, false);

        // Flight: Santiago (SCL) to Calama (CJC)
        addRouteSegment(coords.santiagoAirport, coords.calamaAirport, colors.flight, true);
        
        // Route labels
        const routeLabels = [
            { coords: [-33.35, -71.25], text: '1.5h' },   // Santiago ‚Üí Valpara√≠so
            { coords: [-33.15, -70.95], text: '1.5h' },   // Valpara√≠so ‚Üí Santiago airport
            { coords: [-22.7, -68.55], text: '1h' },      // Calama ‚Üí San Pedro
            { coords: [-23.25, -69.4], text: '3.5h' },    // San Pedro ‚Üí Antofagasta
            { coords: [-25.5, -70.6], text: '4.5h' },     // Antofagasta ‚Üí Bah√≠a Inglesa
            { coords: [-28.55, -70.95], text: '4.5h' },   // Bah√≠a Inglesa ‚Üí La Serena
            { coords: [-31.7, -70.85], text: '5h' },      // La Serena ‚Üí Santiago
        ];
        
        routeLabels.forEach(label => {
            L.marker(label.coords, {
                icon: L.divIcon({
                    className: 'route-label-icon',
                    html: `<div class="route-label">${label.text}</div>`,
                    iconSize: [36, 18],
                    iconAnchor: [18, 9]
                }),
                interactive: false
            }).addTo(map);
        });
        
        // Flight label
        L.marker([-27.95, -69.8], {
            icon: L.divIcon({
                className: 'route-label-icon',
                html: `<div class="route-label" style="background: ${colors.flight}; color: white;">‚úà 2h</div>`,
                iconSize: [42, 18],
                iconAnchor: [21, 9]
            }),
            interactive: false
        }).addTo(map);
        
        // Marker refs
        const markerRefs = {};
        
        // Add overnight markers
        overnightStays.forEach(stay => {
            const marker = L.marker(stay.coords, {
                icon: createSleepMarker(stay.label),
                zIndexOffset: 1000
            }).addTo(map);
            
            let popup = `
                <div class="popup-title">${stay.name}</div>
                <div class="popup-date">${stay.dates} ¬∑ ${stay.nights} night${stay.nights > 1 ? 's' : ''}</div>
                <div class="popup-desc">${stay.desc}</div>
            `;
            if (stay.accom) {
                popup += `<div class="popup-meta" style="font-weight: 500; color: #555;">üè® ${stay.accom}</div>`;
            }
            if (stay.drive) {
                popup += `<div class="popup-meta">${stay.drive}</div>`;
            }
            
            marker.bindPopup(popup);
            markerRefs[stay.id] = marker;
        });
        
        // Add highlight markers
        highlights.forEach(h => {
            const marker = L.marker(h.coords, {
                icon: createHighlightMarker()
            }).addTo(map);
            
            marker.bindPopup(`
                <div class="popup-title">${h.name}</div>
                <div class="popup-date">${h.date}</div>
                <div class="popup-desc">${h.desc}</div>
                <div class="popup-meta">${h.from}</div>
            `);
        });
        
        // Legend (desktop)
        const legend = L.control({ position: 'bottomleft' });
        legend.onAdd = function() {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <h4>Chile Feb 2026</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: ${colors.sleep};"></div>
                    <span>Overnight stay</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: ${colors.highlight}; width: 10px; height: 10px;"></div>
                    <span>Day trip</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line" style="background: ${colors.route};"></div>
                    <span>Drive</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line" style="background: ${colors.flight};"></div>
                    <span>Flight</span>
                </div>
            `;
            return div;
        };
        legend.addTo(map);
        
        // Info panel
        const infoPanel = L.control({ position: 'topright' });
        infoPanel.onAdd = function() {
            const div = L.DomUtil.create('div', 'info-panel');
            div.id = 'infoPanel';
            
            let html = `
                <div class="panel-header">
                    <h3>üá®üá± Itinerary</h3>
                    <button class="panel-close" onclick="closePanel()">√ó</button>
                </div>
                <div class="panel-content">
            `;
            
            overnightStays.forEach(stay => {
                html += `
                    <div class="day-item" onclick="flyToStop(${stay.id})">
                        <div class="day-number">${stay.label}</div>
                        <div class="day-info">
                            <div class="day-location">${stay.name}</div>
                            <div class="day-dates">${stay.dates}</div>
                            <div class="day-activity">${stay.desc}</div>
                            ${stay.accom ? `<div class="day-drive" style="color: #666;">üè® ${stay.accom}</div>` : ''}
                            ${stay.drive ? `<div class="day-drive">${stay.drive}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            div.innerHTML = html;
            
            L.DomEvent.disableClickPropagation(div);
            L.DomEvent.disableScrollPropagation(div);
            
            return div;
        };
        infoPanel.addTo(map);
        
        // Panel toggle (mobile)
        const toggle = document.getElementById('panelToggle');
        const overlay = document.getElementById('panelOverlay');
        
        toggle.addEventListener('click', function() {
            document.getElementById('infoPanel').classList.add('open');
            overlay.classList.add('open');
        });
        
        overlay.addEventListener('click', function() { closePanel(); });
        
        window.closePanel = function() {
            document.getElementById('infoPanel').classList.remove('open');
            overlay.classList.remove('open');
        };
        
        window.flyToStop = function(id) {
            const stay = overnightStays.find(s => s.id === id);
            if (stay) {
                // Close panel on mobile
                if (window.innerWidth <= 600) {
                    closePanel();
                }
                map.flyTo(stay.coords, 9, { duration: 0.6 });
                setTimeout(() => {
                    markerRefs[id].openPopup();
                }, 600);
            }
        };

        // Details modal
        const detailsToggle = document.getElementById('detailsToggle');
        const detailsModal = document.getElementById('detailsModal');

        detailsToggle.addEventListener('click', function() {
            detailsModal.classList.add('open');
        });

        detailsModal.addEventListener('click', function(e) {
            if (e.target === detailsModal) {
                closeDetails();
            }
        });

        window.closeDetails = function() {
            detailsModal.classList.remove('open');
        };

        // Close on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDetails();
                closePanel();
            }
        });
    </script>
</body>
</html>
